package com.abhiram.malwareremover.model;

import org.apache.commons.io.IOUtil;
import org.objectweb.asm.ClassReader;
import org.objectweb.asm.tree.ClassNode;

import java.io.File;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;

public class PluginFile {
    private final File plugin;
    private final ArrayList<ClassNode> nodes = new ArrayList<>();
    private final Map<String, byte[]> files = new HashMap<>();

    public PluginFile(File plugin) {
        this.plugin = plugin;
        try {
            this.loadNodes(plugin);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    public Map<String, byte[]> getFiles() {
        return files;
    }

    public void loadNodes(File file) throws Exception {
        nodes.clear();
        JarFile jar = new JarFile(file);
        Enumeration<JarEntry> enumeration = jar.entries();
        while (enumeration.hasMoreElements()) {
            JarEntry next = enumeration.nextElement();
            if (next.getName().endsWith(".class") || next.getName().endsWith(".class/")) {
                ClassReader reader = new ClassReader(jar.getInputStream(next));
                ClassNode node = new ClassNode();
                try {
                    reader.accept(node, ClassReader.EXPAND_FRAMES);
                } catch (Exception ex) {
                    continue;
                }
                nodes.add(node);
            } else {
                files.put(next.getName(), IOUtil.toByteArray(jar.getInputStream(next)));
            }
        }
        jar.close();
    }


    public ArrayList<ClassNode> getNodes() {
        return this.nodes;
    }

    public File getPlugin() {
        return this.plugin;
    }
}
