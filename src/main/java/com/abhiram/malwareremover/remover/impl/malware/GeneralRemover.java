package com.abhiram.malwareremover.remover.impl.malware;

import com.abhiram.malwareremover.model.PluginFile;
import com.abhiram.malwareremover.remover.IRemover;
import org.apache.commons.io.IOUtil;
import org.objectweb.asm.tree.AbstractInsnNode;
import org.objectweb.asm.tree.ClassNode;
import org.objectweb.asm.tree.LdcInsnNode;
import org.objectweb.asm.tree.MethodNode;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class GeneralRemover implements IRemover {

    @Override
    public void check(PluginFile plugin) {

        Map<String, List<String>> report = new HashMap<>();

        boolean isInfected = false;

        List<String> fileNames = new ArrayList<>();

        for (ClassNode node : plugin.getNodes()) {
            if (node.name.contains("L10")) {
                isInfected = true;
                break;
            }
            boolean badMethod = false;
            for (MethodNode method : node.methods) {
                for (AbstractInsnNode instruction : method.instructions) {
                    if (instruction instanceof LdcInsnNode) {
                        if (((LdcInsnNode) instruction).cst.toString().contains("plugins/PluginMetrics.jar")) {
                            report.computeIfAbsent(node.name, k -> new ArrayList<>()).add(node.name + "." + method.name + method.desc);
                            isInfected = true;
                            badMethod = true;
                        } else if (badMethod && ((LdcInsnNode) instruction).cst.toString().contains(".")) {
                            fileNames.add(((LdcInsnNode) instruction).cst.toString());
                        }
                    }
                }
            }
        }

        for (String s : plugin.getFiles().keySet()) {
            if (fileNames.contains(s)) {
                report.computeIfAbsent("File", k -> new ArrayList<>()).add(s);
            }
        }

        if (isInfected) {
            System.err.println(this.getClass().getSimpleName() + ": " + plugin.getPlugin().getName() + " is infected with HostFlow");
            report.forEach((k, v) -> System.err.println("Report: " + k + " -> " + v));
        }
    }
}
